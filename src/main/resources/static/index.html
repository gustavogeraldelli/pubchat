<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>pubchat app</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        body {
            font-family: sans-serif;
            background-color: #1a202c;
            color: #e2e8f0;
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 500px;
            padding: 2rem;
        }

        h2 {
            margin-top: 0;
            text-align: center;
            margin-bottom: 1.5rem;
        }

        input[type="text"] {
            width: calc(100% - 22px);
            padding: 10px;
            border: 1px solid #4a5568;
            background-color: #2d3748;
            color: #e2e8f0;
            border-radius: 6px;
            margin-bottom: 1rem;
        }

        button {
            padding: 10px 15px;
            border: none;
            border-radius: 6px;
            background-color: #6b7280;
            color: white;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
        }

        button:hover {
            background-color: #e2e8f0;
            color: #1a202c;
        }

        #response {
            height: 250px;
            overflow-y: auto;
            margin-bottom: 1rem;
        }

        #response p {
            margin: 0;
            padding: 8px 0;
            border-bottom: 1px solid #4a5568;
        }

        #response p:last-child {
            border-bottom: none;
        }

        #typing-indicator {
            height: 1.25rem;
            font-style: italic;
            color: #a0aec0;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>

    <div class="container">
        <div id="user-login">
            <h2>Choose a nickname</h2>
            <input type="text" id="sender" placeholder="Your nickname" required/>
            <div>
                <button id="connect" onclick="connect()">Connect</button>
            </div>
        </div>

        <div id="chat-div" style="display: none">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h2 id="room-title">Public Chat</h2>
                <button id="disconnect" onclick="disconnect()">Disconnect</button>
            </div>
            <div style="margin-bottom: 1rem; display: flex; gap: 10px;">
                <button id="create-room" onclick="createRoom()">Create Room</button>
                <button id="join-room" onclick="joinRoom()">Join Room</button>
                <button id="leave-room" onclick="goToRoom('global')">Back to Global</button>
            </div>
            <div id="response"></div>
            <div id="is-typing"></div>
            <div style="display: flex">
                <input type="text" id="message" oninput="sendTypingStatus()" placeholder="Write a message..." style="flex-grow: 1; margin-bottom: 0;"/>
                <button id="send" onclick="sendMessage()">Send</button>
            </div>
        </div>
    </div>

    <script>
        const chatDiv = document.getElementById('chat-div')
        const responseDiv = document.getElementById('response')
        const senderInput = document.getElementById('sender')
        const messageInput = document.getElementById('message')
        const userLoginDiv = document.getElementById('user-login')
        const roomTitle = document.getElementById('room-title')
        const isTypingDiv = document.getElementById('is-typing')

        let stompClient = null
        let sender = null
        let currentRoom = 'global'
        let currentSub = null
        let typingTimeout = null

        function setConnected(connected) {
            if (connected) {
                userLoginDiv.style.display = 'none'
                chatDiv.style.display = 'block'
            } else {
                userLoginDiv.style.display = 'block'
                chatDiv.style.display = 'none'
            }
            responseDiv.innerHTML = ''
        }

        function connect() {
            sender = senderInput.value.trim()
            if (!sender) {
                alert("Please, choose a nickname")
                return
            }
            let socket = new SockJS('/pubchat-websocket')
            stompClient = Stomp.over(socket)
            stompClient.connect({}, function() {
                setConnected(true)
                goToRoom('global')
            })
        }

        function disconnect() {
            if (stompClient != null)
                stompClient.disconnect()
            setConnected(false)
            console.log("Disconnected")
        }

        function sendMessage() {
            let msgText = messageInput.value.trim()
            if (msgText) {
                stompClient.send(`/pubchat/room/${currentRoom}`, {},
                    JSON.stringify({'sender': sender, 'message': msgText, 'type': 'CHAT' }))
                messageInput.value = ''
            }
        }

        function sendTypingStatus() {
            if (stompClient && currentRoom !== 'global')
                stompClient.send(`/pubchat/typing/${currentRoom}`, {},
                    JSON.stringify({'sender': sender, 'type': 'TYPING'}))
        }

        function displayMessage(incomingMessage) {
            switch (incomingMessage.type) {
                case 'CHAT':
                    if (isTypingDiv.textContent.includes(incomingMessage.sender))
                        isTypingDiv.textContent = ''
                    let p = document.createElement('p')
                    p.textContent = `${incomingMessage.sender}: ${incomingMessage.message}`
                    responseDiv.appendChild(p)
                    responseDiv.scrollTop = responseDiv.scrollHeight
                    break
                case 'TYPING':
                    if (incomingMessage.sender !== sender) {
                        isTypingDiv.textContent = `${incomingMessage.sender} is typing...`
                        clearTimeout(typingTimeout)
                        typingTimeout = setTimeout(() => { isTypingDiv.textContent = ''; }, 5000)
                    }
            }
        }

        function goToRoom(room) {
            if (currentSub)
                currentSub.unsubscribe()
            responseDiv.innerHTML = '' // since the url stays the same, the old chat messages needs to be cleaned
            isTypingDiv.textContent = ''

            if (room === 'global') {
                roomTitle.textContent = 'Public Chat'
                document.getElementById('leave-room').style.visibility = 'hidden'
                document.getElementById('create-room').style.visibility = 'visible'
                document.getElementById('join-room').style.visibility = 'visible'
            }
            else {
                roomTitle.textContent = `Room ${room}`
                document.getElementById('leave-room').style.visibility = 'visible'
                document.getElementById('create-room').style.visibility = 'hidden'
                document.getElementById('join-room').style.visibility = 'hidden'
            }
            currentRoom = room
            currentSub = stompClient.subscribe(`/topic/room/${room}`, function (incomingMessage) {
                displayMessage(JSON.parse(incomingMessage.body))
            })
        }

        async function createRoom() {
            try {
                const response = await fetch('/pubchat/rooms', { method: 'POST' })
                const room = await response.text()
                alert("Private room created!\nID: " + room)
                goToRoom(room)
            }
            catch (error) {
                alert("Error creating a room")
            }
        }

        async function joinRoom() {
            let room = prompt("Enter the room ID: ")
            if (room && room.trim() !== '') {
                room = room.trim()
                try {
                    // users cant use any id to join private rooms
                    const available = await fetch(`/pubchat/rooms/${room}/available`)
                    if (available.ok)
                        goToRoom(room)
                    else
                        alert("Invalid ID")
                }
                catch (error) {
                    alert("Error validating room")
                }
            }
        }

        setConnected(false)
    </script>

</body>
</html>
